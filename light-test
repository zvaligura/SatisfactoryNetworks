-- light-test.lua
-- Blink a single Indicator module on a Large Control Panel

local component = component
local event     = event

----------------------------------------------------------
-- CONFIG
----------------------------------------------------------

-- Optional nick of your panel (set via the in-game nick UI).
-- If this is non-empty, the script will try to use it first.
local PANEL_NICK = "light-test-panel"   -- set to "" to skip nick lookup

-- Coordinates of the Indicator module on the Large Control Panel.
-- Origin is bottom-left, x to the right, y up.
local INDICATOR_X = 0
local INDICATOR_Y = 0

-- Blink settings
local BLINK_COUNT      = 6     -- how many times to blink
local BLINK_ON_TIME    = 0.5   -- seconds light stays on
local BLINK_OFF_TIME   = 0.5   -- seconds light stays off

-- Colors (r,g,b,e) in 0.0–1.0 for RGB, 0.0–5.0 for emissive
local ON_COLOR  = { r = 0,   g = 1,   b = 0,   e = 4 }  -- bright green 
local OFF_COLOR = { r = 0,   g = 0,   b = 0,   e = 0 }  -- off

----------------------------------------------------------
-- HELPERS
----------------------------------------------------------

local function findPanelByNick(nick)
    if not nick or nick == "" then
        return nil
    end

    local ids = { component.findComponent(nick) }
    local firstList = ids[1]
    if type(firstList) == "table" and firstList[1] ~= nil then
        return component.proxy(firstList[1])
    elseif type(firstList) == "string" then
        return component.proxy(firstList)
    end

    return nil
end

local function findAnyLargeControlPanel()
    -- Use class lookup for LargeControlPanel
    local ids = component.findComponent(classes.LargeControlPanel)
    if not ids or #ids == 0 then
        return nil
    end
    local panels = component.proxy(ids)
    return panels[1]
end

local function getPanel()
    local panel = nil

    -- Try nick first
    panel = findPanelByNick(PANEL_NICK)
    if panel then
        print("[light-test] Using panel by nick: " .. PANEL_NICK)
        return panel
    end

    -- Fallback: first Large Control Panel found on the network
    panel = findAnyLargeControlPanel()
    if not panel then
        error("[light-test] No Large Control Panel found on the network")
    end

    print("[light-test] Using first LargeControlPanel found")
    return panel
end

local function getIndicatorModule(panel)
    -- Large Control Panel uses getModule(x, y) with 2 coordinates only 
    local module = panel:getModule(INDICATOR_X, INDICATOR_Y)
    if not module then
        error("[light-test] No module at (" .. INDICATOR_X .. "," .. INDICATOR_Y .. ") on panel")
    end

    -- This should be an IndicatorModule with setColor(r,g,b,e) 
    if not module.setColor then
        error("[light-test] Module at (" .. INDICATOR_X .. "," .. INDICATOR_Y .. ") has no setColor, is it an Indicator?")
    end

    return module
end

local function setColor(mod, color)
    mod:setColor(color.r, color.g, color.b, color.e)
end

local function blinkIndicator(indicator)
    print("[light-test] Blinking indicator " .. BLINK_COUNT .. " times")

    for i = 1, BLINK_COUNT do
        print("[light-test] Blink " .. i .. " / " .. BLINK_COUNT)
        setColor(indicator, ON_COLOR)
        event.pull(BLINK_ON_TIME)
        setColor(indicator, OFF_COLOR)
        event.pull(BLINK_OFF_TIME)
    end

    -- Leave the light on at the end so you can see it's alive
    setColor(indicator, ON_COLOR)
    print("[light-test] Done blinking, left ON_COLOR set")
end

----------------------------------------------------------
-- MAIN
----------------------------------------------------------

local function main()
    print("=== light-test starting ===")

    local panel = getPanel()
    print("[light-test] Panel OK")

    local indicator = getIndicatorModule(panel)
    print("[light-test] Indicator module OK at (" .. INDICATOR_X .. "," .. INDICATOR_Y .. ")")

    blinkIndicator(indicator)

    print("=== light-test finished ===")
end

main()
