-- computer-run.lua
-- Generic GitHub loader for FicsIt Networks

local fs = filesystem

----------------------------------------------------------------
-- CONFIG: change these if you move the repo or target script
----------------------------------------------------------------
local GITHUB_USER   = "zvaligura"          -- your GitHub username
local GITHUB_REPO   = "SatisfactoryNetworks" -- your repo name
local GITHUB_BRANCH = "main"               -- branch name

-- Path inside the repo to the script this computer should run.
-- Example: "light-test.lua" or "computers/hub/main.lua"
-- Change this per-computer.
local REMOTE_SCRIPT_PATH = "light-test.lua"
----------------------------------------------------------------

local function normalizePath(path)
    if path:sub(1, 1) == "/" then
        return path:sub(2)
    end
    return path
end

local function buildRawUrl(path)
    path = normalizePath(path)
    return "https://raw.githubusercontent.com/"
        .. GITHUB_USER .. "/"
        .. GITHUB_REPO .. "/"
        .. GITHUB_BRANCH .. "/"
        .. path
end

local function initFileSystem()
    if fs.initFileSystem("/dev") == false then
        computer.panic("Cannot initialize /dev")
    end

    local drive = nil
    for _, child in pairs(fs.childs("/dev")) do
        if child ~= "serial" then
            drive = child
            break
        end
    end

    if not drive then
        computer.panic("No drive found. Insert a disk or hard drive.")
    end

    fs.mount("/dev/" .. drive, "/")
end

local function ensureParentDir(path)
    local dir = path:match("(.+)/[^/]+$")
    if dir and dir ~= "/" then
        fs.createDir(dir, true)
    end
end

local function downloadAndSave(url, localPath)
    local cards = computer.getPCIDevices(classes.FINInternetCard)
    if not cards or #cards == 0 then
        return false, "No FINInternetCard PCI device found"
    end

    local card = cards[1]
    print("[computer-run] GET " .. url)
    local req = card:request(url, "GET", "")
    local _, body = req:await()

    if not body or body == "" then
        return false, "Empty HTTP response"
    end

    ensureParentDir(localPath)

    local file, err = fs.open(localPath, "w")
    if not file then
        return false, "Failed to open " .. localPath .. ": " .. tostring(err)
    end

    file:write(body)
    file:close()

    print("[computer-run] Saved script to " .. localPath)
    return true
end

local function main()
    print("=== computer-run starting ===")
    print("Repo:   " .. GITHUB_USER .. "/" .. GITHUB_REPO)
    print("Branch: " .. GITHUB_BRANCH)
    print("Target: " .. REMOTE_SCRIPT_PATH)

    initFileSystem()

    local localScriptPath = "/boot/remote-main.lua"
    local url = buildRawUrl(REMOTE_SCRIPT_PATH)

    local ok, err = downloadAndSave(url, localScriptPath)
    if not ok then
        print("[computer-run] Download failed: " .. tostring(err))
        if fs.exists(localScriptPath) then
            print("[computer-run] Using cached script: " .. localScriptPath)
        else
            error("[computer-run] No script available, aborting")
        end
    end

    print("[computer-run] Executing " .. localScriptPath)
    local success, runErr = pcall(function()
        fs.doFile(localScriptPath)
    end)

    if not success then
        print("[computer-run] Error while running script:")
        print(runErr)
    end

    print("=== computer-run done ===")
end

main()
